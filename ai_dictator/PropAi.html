{{ extends "global/Page.html" }}
{{ load otree }}

{{ block title }}
Reassessment
{{ endblock }}
{{ block content }}


<div>
    <p>We have sent the followong question to an AI agent, asking what it would do in your position. After it responds,
        if you wish,
        you can reassess your decision on how much to give the other player..</p>

    <div class="ai-prompt-text row">
        <p>{{C.AI_PROMPT}}</p>
    </div>
    <p></p>
</div>

<div id="intro" style="display: block;">
    <div class="ai-idea-text row">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
            <p>Waiting for AI response...</p>
            <p>Please be patient, this can take up to 30s</p>
        </div>
    </div>
    <p></p>
</div>

<div id="error_message" style="display: none;">
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> <span id="error_text"></span>
        <br><strong>Please refresh your browser page to try again</strong>
    </div>
</div>

<div id="ai_response" style="display: none;">
    <p>The AI agent has responded. This is its suggestion:</p>
    <div class="ai-idea-text row">
        <p id="ai_text"></p>
    </div>

    <p>(You previously decided you would give {{ player.amount_to_give|to2 }}.)</p>

    {{formfield player.revised_amount_to_give }}

</div>

<button id="reassess_button" disabled="true" class="btn btn-primary">
    Reassess Decision
</button>

<script>

    let pendingRequests = false;

    /*
 * Handler for server response to liveSend method
 */
    function liveRecv(data) {
        // javascript destructuring assignment
        // "respones: [{"status": status, "text": text, "index": index},]
        let { responses } = data;

        for (index = 0; index < responses.length; index++) {
            response = responses[index];
            ideaIndex = response['index'];
            text = response['text'];
            status = response['status'];

            console.log("Status: " + status + ", text: " + text + ", index: " + ideaIndex)
            if (status == "Suggestion") {
                showIdea(ideaIndex, text)

            } else if (status == "Error") {
                showError(ideaIndex, text)

            } else {
                console.log("ERROR: don't understand status: " + response['status'])
                continue;
            }
            pendingRequests = false;
        }
    }

    function showIdea(ideaIndex, text) {
        console.log("Showing idea index " + ideaIndex + ": " + text)
        document.getElementById("ai_text").innerText = text;
        document.getElementById("intro").style.display = "none";
        console.log("Displaying ai response div");
        document.getElementById("ai_response").style.display = "block";
        document.getElementById("reassess_button").disabled = false;
    }

    function showError(ideaIndex, text) {
        console.log("Showing idea index " + ideaIndex + ": " + text)
        document.getElementById("error_text").innerText = text;
        document.getElementById("intro").style.display = "none";
        console.log("Displaying ai response div");
        document.getElementById("error_message").style.display = "block";
        document.getElementById("reassess_button").disabled = true;
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Get the first idea from the AI on page load
        liveSend({ 'type': 'generate', 'index': 0 })
        pendingRequests = true;

        // Set up a poller to check for AI response every 2 seconds
        refreshInterval = setInterval(() => {
            if (pendingRequests === false) {
                console.log("Nothing left to update, deleting interval")
                clearInterval(refreshInterval);
            } else {
                console.log("Still want some ideas back.")
                liveSend({ 'type': 'poll', 'pendingIndexes': [0] });
            }
        }, 2000)
    });
</script>

{{ endblock }}